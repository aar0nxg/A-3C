<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixel Purple Rocket ‚Äî Love Run</title>
  <style>
    :root { --bg1:#12001f; --bg2:#2a0a4a; --fg:#e2c6ff; --accent:#b28bff; --danger:#ff6fb3; --success:#8dffca; }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--fg);font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";}
    #wrap{position:fixed;inset:0;display:flex;flex-direction:column;}
    #hud{display:flex;gap:.5rem .75rem;align-items:center;justify-content:space-between;flex-wrap:wrap;padding:.6rem 1rem;font-weight:700}
    #hud .pill{background:rgba(255,255,255,.08);padding:.35rem .6rem;border-radius:999px;backdrop-filter: blur(6px); box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset;}
    #hud .toggles{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}
    #hud .toggles .pill{cursor:pointer;user-select:none}
    #game{flex:1;position:relative;}
    canvas{position:absolute;inset:0;width:100%;height:100%;image-rendering: pixelated;image-rendering: crisp-edges;}
    #centerMsg{position:absolute;inset:0;display:none;place-items:center;pointer-events:none;text-align:center;padding:1rem;}
    #centerMsg .card{pointer-events:auto;max-width:680px;background:rgba(42,10,74,.72);border:1px solid rgba(255,255,255,.15);border-radius:18px;padding:18px 16px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .btn{cursor:pointer;display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:14px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--fg);font-weight:700}
    .btn:hover{background:rgba(255,255,255,.14)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:.5rem}
    small{opacity:.85}
    #touchHint{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);opacity:.9;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:.4rem .7rem;border-radius:999px;font-weight:700}
    #scanlines{pointer-events:none;position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,.12) 0px, rgba(0,0,0,.12) 1px, transparent 1px, transparent 3px);opacity:0;transition:opacity .2s ease}

    /* toast */
    #toast{position:absolute;left:50%;top:12%;transform:translateX(-50%);padding:.4rem .7rem;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);border-radius:999px;font-weight:800;letter-spacing:.02em;opacity:0;transition:opacity .2s ease;pointer-events:none}

    /* ending image fade */
    @keyframes fadeIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="hud">
      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
        <div class="pill">‚è±Ô∏è <span id="timer">03:00</span></div>
        <div class="pill">‚≠ê Score: <span id="score">0</span></div>
        <div class="pill">üèÜ Best: <span id="best">0</span></div>
        <div class="pill">üöÄ Speed: <span id="speed">1.0x</span></div>
        <div class="pill">üéØ Combo: <span id="combo">0</span></div>
        <div class="pill">üïπÔ∏è Controls: <span id="controls">Space / Tap ‚Ä¢ P=Photo</span></div>
      </div>
      <div class="toggles">
        <div class="pill" id="btnPause">‚è∏Ô∏è Pause</div>
        <div class="pill" id="btnMute">üîä Sound</div>
        <div class="pill" id="btnAssist">üõ°Ô∏è Assist OFF</div>
        <div class="pill" id="btnColorSafe">üé® Color-Safe OFF</div>
        <div class="pill" id="btnFX">‚ú® FX ON</div>
        <div class="pill" id="btnCRT">üì∫ CRT OFF</div>
      </div>
    </div>
    <div id="game">
      <canvas id="c"></canvas>
      <div id="scanlines"></div>
      <div id="toast"></div>
      <div id="centerMsg"><div class="card" id="centerCard"></div></div>
      <div id="touchHint">TAP to thrust</div>
    </div>
  </div>

<script>
(() => {
  // ====== pixel canvas ======
  const view = document.getElementById('c');
  const ctx = view.getContext('2d');
  const W = 320, H = 180;
  const buffer = document.createElement('canvas'); buffer.width=W; buffer.height=H;
  const g = buffer.getContext('2d'); g.imageSmoothingEnabled=false; ctx.imageSmoothingEnabled=false;

  // ====== constants (unchanged core) ======
  const DURATION = 180000; // EXACTLY 3 minutes
  const GRAVITY_BASE = 0.28;   // base gravity; assist may scale
  let   GRAVITY = GRAVITY_BASE;
  const FLAP = -5.4;

  const BASE_SPEED = 0.42;
  const MAX_SPEED  = 2.0;
  const ASTEROID_INTERVAL_MIN = 750;
  const ASTEROID_INTERVAL_MAX = 2100;

  const START_GRACE = 1500;           // first 1.5s: no asteroids
  const GF_PREVIEW_WINDOW = 30000;    // last 30s: preview
  const ROCKET_X = 56;

  // parallax
  const NEBULA_COUNT   = 6;
  const PLANET_COUNT   = 2;
  const NEBULA_PARALLAX = 0.18;
  const PLANET_PARALLAX = 0.10;

  // FX
  const TRAIL_MAX = 42;
  const TRAIL_SPAWN_INTERVAL = 40;
  const SPARKLE_BURST = 12;
  const SPARKLE_DRIP = 2;
  const SPARKLE_INTERVAL = 60;

  // near-miss
  const NEAR_MISS_PAD = 3;     // px clearance to count as near-miss
  const NEAR_MISS_BONUS = 2;   // bonus score
  const COMBO_DECAY_MS = 1800; // time to decay combo by 1

  // comets & cameos
  const COMET_RATE = 0.00025; // probability per ms
  const CAMEO_OWL_MINUTE = 2;
  const CAMEO_BAT_MINUTE = 3;
  const PITBULL_CHANCE = 0.15; // chance to spawn cameo once per run

  // toggles state
  let ASSIST=false, COLOR_SAFE=false, REDUCED_FX=false, CRT=false, MUTED=false, PAUSED=false, PHOTO=false;

  // --- Rider (HD) ---
  const AARON_SRC = "aaron.jpg";
  const AARON_W   = 12; let AARON_H = 12;
  const AARON_OFF_X = 3, AARON_OFF_Y = -6;
  const aaronImg = new Image(); let aaronReady=false;
  aaronImg.onload = () => { const r=aaronImg.height/aaronImg.width; AARON_H=Math.max(1,Math.round(AARON_W*r)); aaronReady=true; };
  aaronImg.src = AARON_SRC;

  // --- Girlfriend (HD) ---
  const GF_SRC = "chandrima.png";
  const GF_W   = 18; let GF_H = 26;
  const gfImg = new Image(); let gfReady=false;
  gfImg.onload = () => { const r=gfImg.height/gfImg.width; GF_H=Math.max(1,Math.round(GF_W*r)); gfReady=true; };
  gfImg.src = GF_SRC;

  // --- Ending embrace image on win card ---
  const embraceImg = new Image(); let embraceReady=false;
  embraceImg.onload = ()=> embraceReady=true;
  embraceImg.src = "embrace.png";

  // ====== state ======
  let playing=false, finished=false, crashed=false, startedAt=0, elapsed=0, lastFrame=0;
  let pausedAt=0;
  let score=0, best=Number(localStorage.getItem('bestScore')||0);
  let combo=0, comboDecayAt=0;
  let rocket={x:ROCKET_X,y:H/2,vy:0,w:16,h:10,invuln:0};
  let obstacles=[]; let stars=[]; let nextAsteroidAt=0;
  let gfPreview=null; let girlfriend=null;
  let nebula=[]; let planets=[]; let comets=[];
  let trail=[]; let sparkles=[]; let butterflies=[];
  let lastTrailAt=0, nextSparkleAt=0;
  let owlCameo=false, batCameo=false, pitbull=null;

  // ====== ui refs ======
  const uiTimer=document.getElementById('timer');
  const uiScore=document.getElementById('score');
  const uiBest=document.getElementById('best'); uiBest.textContent=best;
  const uiSpeed=document.getElementById('speed');
  const uiCombo=document.getElementById('combo');
  const centerMsg=document.getElementById('centerMsg');
  const centerCard=document.getElementById('centerCard');
  const touchHint=document.getElementById('touchHint');
  const scanlines=document.getElementById('scanlines');
  const toastEl=document.getElementById('toast');

  // ====== BEST SCORE HELPERS (NEW) ======
  function setBest(val){
    try { localStorage.setItem('bestScore', String(val)); } catch(e){}
    best = val;
    uiBest.textContent = best;
  }
  function updateBestIfNeeded(){
    if (score > best) setBest(score);
  }

  // ====== input ======
  window.addEventListener('keydown', e=>{
    if(e.code==='Space'){ e.preventDefault(); flap(); }
    if(e.code==='Escape'){ togglePause(); }
    if(e.key.toLowerCase()==='p'){ togglePhoto(); }
    if(e.key.toLowerCase()==='m'){ toggleMute(); }
    if(e.key.toLowerCase()==='a'){ toggleAssist(); }
  });
  window.addEventListener('touchstart', ()=>flap(), {passive:true});
  window.addEventListener('mousedown', ()=>flap());

  // HUD toggle buttons
  document.getElementById('btnPause').onclick = ()=>togglePause();
  document.getElementById('btnMute').onclick = ()=>toggleMute();
  document.getElementById('btnAssist').onclick = ()=>toggleAssist();
  document.getElementById('btnColorSafe').onclick = ()=>{ COLOR_SAFE=!COLOR_SAFE; document.getElementById('btnColorSafe').textContent = COLOR_SAFE?'üé® Color-Safe ON':'üé® Color-Safe OFF'; };
  document.getElementById('btnFX').onclick = ()=>{ REDUCED_FX=!REDUCED_FX; document.getElementById('btnFX').textContent = REDUCED_FX?'‚ú® FX OFF':'‚ú® FX ON'; };
  document.getElementById('btnCRT').onclick = ()=>{ CRT=!CRT; scanlines.style.opacity = CRT? '0.28':'0'; document.getElementById('btnCRT').textContent = CRT?'üì∫ CRT ON':'üì∫ CRT OFF'; };

  function flap(){
    if(!playing && !finished){ start(); }
    if(playing && !PAUSED){
      rocket.vy = FLAP;
      spawnThrustBurst();
      sfx('thrust');
    }
  }

  // overlay helpers
  function showCenter(html){ centerCard.innerHTML=html; centerMsg.style.display='grid'; }
  function hideCenter(){ centerMsg.style.display='none'; centerCard.innerHTML=''; }
  function toast(msg, ms=1200){ toastEl.textContent=msg; toastEl.style.opacity='1'; setTimeout(()=>toastEl.style.opacity='0', ms); }

  // screens
  function showIntro(){
    const html = `
      <h2 style="margin:4px 0 10px">üíú Pixel Purple Rocket ‚Äî Love Run</h2>
      <p style="margin:0 0 8px">Fly for <b>3 minutes</b>, dodge asteroids, then at the end you reach your love.</p>
      <div class="row"><button class="btn" id="btnStart">Start (Space/Tap)</button><button class="btn" id="btnHow">How to Play</button></div>
      <small>Mobile friendly ‚Ä¢ Pixel-art vibes ‚Ä¢ Ramps steadily</small>`;
    showCenter(html);
    document.getElementById('btnStart').onclick=()=>start();
    document.getElementById('btnHow').onclick =()=>showHow();
  }
  function showHow(){
    const html=`<h3>Controls</h3>
    <ul style="text-align:left;line-height:1.5">
      <li><b>Space</b> (desktop) or <b>tap</b> (phone) to thrust up</li>
      <li>Release to fall ‚Ä¢ Avoid asteroids</li>
      <li>Last 30s: you can <i>see</i> her ahead; at 0:00 you can reach her üíû</li>
      <li><b>P</b> for Photo Mode; <b>Esc</b> Pause; <b>M</b> Mute; <b>A</b> Assist</li>
    </ul>
    <div class="row"><button class="btn" id="btnBack">Back</button></div>`;
    showCenter(html);
    document.getElementById('btnBack').onclick=()=>showIntro();
  }
  function showCrash(){
    sfx('crash'); vib(40);
    const html=`<h2>üí• Oops! You crashed</h2><p>Score: <b>${score}</b> ‚Ä¢ Best: <b>${best}</b></p><div class="row"><button class="btn" id="btnRetry">Try Again</button></div>`;
    showCenter(html);
    document.getElementById('btnRetry').onclick=()=>start();
  }
  function showWin(){
    sfx('win'); vib([20,40,20]);
    const imgTag = embraceReady
      ? `<img src="embrace.png" alt="Aaron and Chandrima embrace" style="margin-top:10px;width:160px;max-width:70%;border-radius:12px;box-shadow:0 0 20px rgba(255,170,255,0.4);animation:fadeIn 1.2s ease-out;">`
      : '';
    const html = `
      <h2>üíû You made it!</h2>
      <p>You reached her after a 3-minute run. Score: <b>${score}</b> ‚Ä¢ Best: <b>${best}</b></p>
      ${imgTag}
      <div class="row">
        <button class="btn" id="btnReplay">Replay</button>
        <button class="btn" id="btnShare">Share</button>
      </div>
      <small>Tip: Press P any time for a screenshot</small>
    `;
    showCenter(html);
    document.getElementById('btnReplay').onclick=()=>start();
    document.getElementById('btnShare').onclick=()=>saveScreenshot();
  }

  // start/end
  function start(){
    hideCenter(); touchHint.style.display='none';
    playing=true; crashed=false; finished=false; PAUSED=false; PHOTO=false;
    document.getElementById('btnPause').textContent='‚è∏Ô∏è Pause';
    score=0; combo=0; obstacles=[]; stars=[]; nebula=[]; planets=[]; comets=[];
    trail=[]; sparkles=[]; butterflies=[]; lastTrailAt=0; nextSparkleAt=0;
    gfPreview=null; girlfriend=null; owlCameo=false; batCameo=false; pitbull=null;
    GRAVITY = ASSIST ? GRAVITY_BASE*0.9 : GRAVITY_BASE;

    rocket.y=H/2; rocket.vy=0; rocket.invuln=800;
    startedAt=performance.now(); lastFrame=startedAt; elapsed=0; nextAsteroidAt=0;

    // seed layers
    for(let i=0;i<80;i++) stars.push(newStar(Math.random()*W, Math.random()*H));
    for (let i=0;i<NEBULA_COUNT;i++) nebula.push(newNebula(Math.random()*W, Math.random()*H));
    for (let i=0;i<PLANET_COUNT;i++) planets.push(newPlanet(Math.random()*W, 20 + Math.random()*(H-40)));

    // maybe spawn pitbull cameo once per run
    if (Math.random() < PITBULL_CHANCE) pitbull = {x: W + 60, y: H - 22, sway:0};

    requestAnimationFrame(loop);
  }
  function endWin(){
    updateBestIfNeeded();           // NEW
    playing=false; finished=true; showWin();
  }
  function endCrash(){
    updateBestIfNeeded();           // NEW
    playing=false; crashed=true; showCrash();
  }

  // toggles
  function togglePause(){
    if(!playing) return;
    PAUSED=!PAUSED;
    document.getElementById('btnPause').textContent = PAUSED ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
    if(PAUSED){ pausedAt=performance.now(); } else {
      const delta = performance.now()-pausedAt; startedAt += delta; lastFrame += delta;
      requestAnimationFrame(loop);
    }
  }
  function togglePhoto(){
    PHOTO = !PHOTO;
    document.getElementById('hud').style.opacity = PHOTO ? '0' : '1';
    if(PHOTO) saveScreenshot();
  }
  function toggleMute(){ MUTED=!MUTED; document.getElementById('btnMute').textContent = MUTED ? 'üîá Muted' : 'üîä Sound'; }
  function toggleAssist(){
    ASSIST = !ASSIST;
    GRAVITY = ASSIST ? GRAVITY_BASE*0.9 : GRAVITY_BASE;
    document.getElementById('btnAssist').textContent = ASSIST ? 'üõ°Ô∏è Assist ON' : 'üõ°Ô∏è Assist OFF';
  }

  // helpers
  function speedAt(t){ const k=Math.min(1,t/DURATION); const eased=k*k; return BASE_SPEED + (MAX_SPEED-BASE_SPEED)*eased; }
  function asteroidIntervalAt(t){ const k=Math.min(1,t/DURATION); return ASTEROID_INTERVAL_MAX + (ASTEROID_INTERVAL_MIN - ASTEROID_INTERVAL_MAX)*k; }
  function formatTime(ms){ const s=Math.ceil(Math.max(0,ms)/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }

  function newStar(x=W+8,y=Math.random()*H){ const layer=Math.random()<0.6?0:(Math.random()<0.5?1:2); return {x,y,layer}; }
  function newAsteroid(){ const r=6+Math.random()*10; const y=12+Math.random()*(H-24); const vy=(Math.random()*0.6-0.3); return {x:W+20,y,r,vy,scored:false, nm:false}; }
  function spawnGirlfriend(){ girlfriend={x: (gfPreview? gfPreview.x : W+60), y: (gfPreview? gfPreview.y : H/2-10), w:GF_W, h:GF_H, sway:(gfPreview? gfPreview.sway:0)||0}; gfPreview=null; }

  // visual layers
  function newNebula(x=W+40,y=Math.random()*H){ const r=26+Math.random()*42; const a=0.08+Math.random()*0.12; const wobble=Math.random()*Math.PI*2; return {x,y,r,a,wobble}; }
  function drawNebula(dt,spd){
    for(let i=nebula.length-1;i>=0;i--){
      const n=nebula[i];
      n.x -= spd*NEBULA_PARALLAX*dt; n.wobble += 0.004;
      const rr = n.r + Math.sin(n.wobble)*2.0;
      const grad = g.createRadialGradient(n.x,n.y,0,n.x,n.y,rr);
      grad.addColorStop(0,`rgba(178,139,255,${n.a})`);
      grad.addColorStop(1,`rgba(178,139,255,0)`);
      g.fillStyle = grad; g.beginPath(); g.arc(n.x|0,n.y|0,rr|0,0,Math.PI*2); g.fill();
      if(n.x < -rr - 10) nebula.splice(i,1);
    }
    while(nebula.length < NEBULA_COUNT) nebula.push(newNebula());
  }

  function newPlanet(x=W+80,y=30+Math.random()*(H-60)){ const r=10+Math.random()*14; const ring=Math.random()<0.5; const hue=Math.random()<0.5?'#6e49a3':'#8a68c0'; return {x,y,r,ring,hue}; }
  function drawPlanets(dt,spd){
    for(let i=planets.length-1;i>=0;i--){
      const p=planets[i];
      p.x -= spd*PLANET_PARALLAX*dt;
      g.fillStyle = `${p.hue}aa`; g.beginPath(); g.arc(p.x|0,p.y|0,p.r|0,0,Math.PI*2); g.fill();
      g.fillStyle = 'rgba(0,0,0,0.25)'; g.beginPath(); g.arc((p.x+2)|0,(p.y+1)|0,p.r|0,Math.PI*0.1,Math.PI*1.1); g.fill();
      if(p.ring){ g.strokeStyle='rgba(226,198,255,0.45)'; g.lineWidth=1; g.beginPath(); g.ellipse(p.x|0,p.y|0,p.r+3,p.r*0.45,0.25,0,Math.PI*2); g.stroke(); }
      if(p.x < -p.r - 20) planets.splice(i,1);
    }
    while(planets.length < PLANET_COUNT) planets.push(newPlanet());
  }

  // comets
  function spawnComet(now){ comets.push({x:W+20, y: 10+Math.random()*(H-20), vx: -0.3 - Math.random()*0.3, vy: (Math.random()*0.2-0.1), life: 5000}); }
  function drawComets(dt, spd){
    for(let i=comets.length-1;i>=0;i--){
      const c=comets[i];
      c.x += (c.vx*dt) - spd*dt*0.2;
      c.y += c.vy*dt;
      c.life -= dt;
      g.fillStyle='#e2c6ff'; g.fillRect(c.x|0, c.y|0, 2,1);
      g.fillStyle='rgba(226,198,255,.5)'; g.fillRect((c.x-2)|0, (c.y+1)|0, 2,1);
      if(c.life<=0 || c.x<-10) comets.splice(i,1);
    }
  }

  // cameo animals (simple pixel silhouettes)
  function drawOwl(dt, spd){
    if(!owlCameo) return;
    owlCameo.x -= spd*dt*0.4; owlCameo.y += Math.sin(owlCameo.t+=0.03)*0.2;
    const x=owlCameo.x|0, y=owlCameo.y|0;
    g.fillStyle='#cbb3ff';
    g.fillRect(x,y,3,1); g.fillRect(x-1,y+1,5,1); g.fillRect(x-2,y+2,7,1); // wings
    if(owlCameo.x<-10) owlCameo=false;
  }
  function drawBat(dt, spd){
    if(!batCameo) return;
    batCameo.x -= spd*dt*0.5; batCameo.y += Math.sin(batCameo.t+=0.05)*0.4;
    const x=batCameo.x|0, y=batCameo.y|0;
    g.fillStyle='#a88fe0';
    g.fillRect(x,y,2,1); g.fillRect(x-2,y+1,6,1);
    if(batCameo.x<-10) batCameo=false;
  }
  function drawPitbull(dt, spd){
    if(!pitbull) return;
    pitbull.x -= spd*dt*0.6; pitbull.sway += 0.05;
    const x=pitbull.x|0, y=pitbull.y|0;
    g.fillStyle='#caa6ff'; g.fillRect(x,y,6,3); g.fillRect(x+1,y-2,3,2); // body + head
    g.fillStyle='#2b0f46'; g.fillRect(x+3,y-1,1,1); // nose
    if(pitbull.x<-12) pitbull=null;
  }

  // particles: trail & sparkles & butterflies
  function maybeAddTrail(now,spd,dt){
    if(REDUCED_FX) return;
    if(now-lastTrailAt>=TRAIL_SPAWN_INTERVAL){ trail.push({ x:rocket.x-3, y:rocket.y+5, r:2, a:1 }); lastTrailAt=now; if(trail.length>TRAIL_MAX) trail.shift(); }
    for(let i=trail.length-1;i>=0;i--){ const p=trail[i]; p.x-=spd*dt*0.6; p.y+=0.02*dt; p.r+=0.005*dt; p.a-=0.0035*dt; if(p.a<=0||p.x<-10) trail.splice(i,1); }
  }
  function drawTrail(){ if(REDUCED_FX) return; for(const p of trail){ g.fillStyle = `rgba(255,154,210,${0.50*Math.max(0,p.a)})`; g.fillRect(p.x|0,p.y|0,2,2); g.fillStyle = `rgba(178,139,255,${0.35*Math.max(0,p.a)})`; g.fillRect((p.x-1)|0,(p.y+1)|0,1,1);} }
  function spawnThrustBurst(){ if(REDUCED_FX) return; for(let i=0;i<SPARKLE_BURST;i++){ sparkles.push({x:rocket.x-2,y:rocket.y+5,vx:-0.02-Math.random()*0.10,vy:(Math.random()*0.5-0.25),life:450+Math.random()*300,a:1}); } }
  function maybeDripSparkles(now){ if(REDUCED_FX) return; if(rocket.vy<0 && now>=nextSparkleAt){ nextSparkleAt=now+SPARKLE_INTERVAL; for(let i=0;i<SPARKLE_DRIP;i++){ sparkles.push({x:rocket.x-2,y:rocket.y+5,vx:-0.02-Math.random()*0.06,vy:(Math.random()*0.4-0.2),life:380+Math.random()*220,a:1}); } } }
  function updateSparkles(dt,spd){ if(REDUCED_FX) return; for(let i=sparkles.length-1;i>=0;i--){ const s=sparkles[i]; s.x += s.vx*dt - spd*dt*0.5; s.y += s.vy*dt; s.vy += 0.0006*dt; s.life -= dt; s.a = Math.max(0, s.life/450); if(s.life<=0 || s.x<-10) sparkles.splice(i,1); } }
  function drawSparkles(){ if(REDUCED_FX) return; for(const s of sparkles){ g.fillStyle=`rgba(255,142,198,${0.9*s.a})`; g.fillRect(s.x|0,s.y|0,1,1); g.fillStyle=`rgba(226,198,255,${0.6*s.a})`; g.fillRect((s.x+1)|0,s.y|0,1,1);} }
  function spawnButterflies(n=2){ if(REDUCED_FX) return; for(let i=0;i<n;i++){ butterflies.push({x:rocket.x+Math.random()*8-4, y:rocket.y+Math.random()*8-4, vx:-0.02-Math.random()*0.04, vy:(Math.random()*0.4-0.2), a:1, life:900+Math.random()*600}); } }
  function updateButterflies(dt, spd){
    for(let i=butterflies.length-1;i>=0;i--){ const b=butterflies[i]; b.x += b.vx*dt - spd*dt*0.2; b.y += b.vy*dt; b.vy += 0.0002*dt; b.life -= dt; b.a = Math.max(0,b.life/900); if(b.life<=0 || b.x<-10) butterflies.splice(i,1); }
  }
  function drawButterflies(){ if(REDUCED_FX) return; for(const b of butterflies){ g.fillStyle=`rgba(255,170,255,${0.8*b.a})`; g.fillRect(b.x|0,b.y|0,1,1); g.fillStyle=`rgba(255,200,255,${0.6*b.a})`; g.fillRect((b.x+1)|0,(b.y)|0,1,1);} }

  // Girlfriend pixel-art fallback
  function drawGirlfriendFallback(entity){
    if(!entity || gfReady) return;
    const gx=entity.x|0, gy=entity.y|0;
    entity.sway=(entity.sway||0)+0.05; const sway=Math.sin(entity.sway)*1.2;
    g.fillStyle='#2b0f46'; g.fillRect(gx+4,gy+1,10,8);
    g.fillStyle='#ffd1ea'; g.fillRect(gx+6,gy+4,6,6);
    g.fillStyle='#2b0f46'; g.fillRect(gx+7,gy+6,1,1); g.fillRect(gx+10,gy+6,1,1);
    g.fillStyle='#b28bff'; g.fillRect(gx+5,gy+11,8,10);
    g.fillStyle='#ffd1ea'; g.fillRect(gx+7,gy+21,2,4); g.fillRect(gx+9,gy+21,2,4);
    g.fillStyle='#ff6fb3'; g.fillRect(gx+1, gy+2+(sway|0),1,1); g.fillRect(gx+2, gy+1+(sway|0),1,1); g.fillRect(gx+2, gy+2+(sway|0),1,1);
  }

  // HD draws on screen canvas
  let lastBlit = {dx:0, dy:0, scale:1, dpr:1};
  function drawAaronRiderHD(){ if(!aaronReady) return; const {dx,dy,scale,dpr} = lastBlit; const sx=dx*dpr + (rocket.x + AARON_OFF_X)*scale*dpr; const sy=dy*dpr + (rocket.y + AARON_OFF_Y)*scale*dpr; const sw=AARON_W*scale*dpr, sh=AARON_H*scale*dpr; const prev=ctx.imageSmoothingEnabled; ctx.imageSmoothingEnabled=true; ctx.drawImage(aaronImg, sx, sy, sw, sh); ctx.imageSmoothingEnabled=prev; }
  function drawChibiHD(entity){ if(!entity || !gfReady) return; const {dx,dy,scale,dpr}=lastBlit; const sx=dx*dpr + (entity.x)*scale*dpr; const sy=dy*dpr + (entity.y)*scale*dpr; const sw=GF_W*scale*dpr, sh=GF_H*scale*dpr; const prev=ctx.imageSmoothingEnabled; ctx.imageSmoothingEnabled=true; ctx.drawImage(gfImg, sx, sy, sw, sh); ctx.imageSmoothingEnabled=prev; }

  // rendering helpers
  function clear(){ const grd=g.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#14002a'); grd.addColorStop(1,'#2a0a4a'); g.fillStyle=grd; g.fillRect(0,0,W,H); }
  function drawStars(dt,spd){ for(const s of stars){ const p=[0.25,0.5,1.0][s.layer]; s.x-=spd*p*dt; if(s.x<-4) Object.assign(s,newStar()); g.fillStyle=['#4b2a6b','#9d6cff','#e2c6ff'][s.layer]; g.fillRect(s.x|0,s.y|0,1,1);} }
  function drawRocket(){ const {x,y}=rocket; const px=(ix,iy,w,h,c)=>{g.fillStyle=c;g.fillRect((x+ix)|0,(y+iy)|0,w,h);}; px(0,2,10,6,'#b28bff'); px(9,3,3,4,'#e2c6ff'); px(3,4,3,2,'#12001f'); px(0,1,2,2,'#8f5bff'); px(0,7,2,2,'#8f5bff'); const flame=Math.max(0,-rocket.vy*0.8); px(-2,4-(flame>0?1:0),2,2+((flame>2)?1:0),'#ff9ad2'); if(rocket.invuln>0&&((performance.now()%200)|0)<100){ g.globalCompositeOperation='lighter'; px(-1,2,1,6,'#ffffff'); g.globalCompositeOperation='source-over'; } }
  function drawAsteroid(a){ g.fillStyle='#6e49a3'; g.beginPath(); g.arc(a.x|0,a.y|0,a.r|0,0,Math.PI*2); g.fill(); g.fillStyle= COLOR_SAFE ? '#ffd07a' : '#8a68c0'; g.fillRect((a.x-1)|0,(a.y-2)|0,2,2); }
  function drawHUDOverlay(timeLeft){ if(timeLeft<7000){ const k=1-timeLeft/7000; g.fillStyle=`rgba(255,170,255,${0.08+0.25*k})`; g.fillRect(0,H-24,W,24);} }

  function aabb(x,y,w,h, x2,y2,w2,h2){ return x < x2+w2 && x+w > x2 && y < y2+h2 && y+h > y2; }

  // audio (WebAudio minimal)
  let AC; function ac(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); return AC; }
  function beep(freq=440, dur=0.08, type='square', vol=0.03){
    if(MUTED) return;
    const ctx=ac(), o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.setValueAtTime(freq, ctx.currentTime);
    g.gain.value=vol; g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+dur);
  }
  function sfx(kind){
    if(MUTED) return;
    if(kind==='thrust') beep(320,0.05,'square',0.02);
    if(kind==='near')   { beep(880,0.05,'triangle',0.03); beep(1320,0.05,'triangle',0.02); }
    if(kind==='crash')  { beep(220,0.15,'sawtooth',0.05); setTimeout(()=>beep(160,0.12,'sawtooth',0.04),70); }
    if(kind==='win')    { beep(660,0.1,'square',0.04); setTimeout(()=>beep(990,0.12,'square',0.04),100); setTimeout(()=>beep(1320,0.14,'square',0.04),220); }
    if(kind==='whoosh') { beep(500,0.03,'sine',0.01); }
  }
  function vib(pattern){ if(navigator.vibrate) navigator.vibrate(pattern); }

  // main loop
  function loop(now){
    if(!playing || PAUSED) return;
    const dt=Math.min(40, now-lastFrame); lastFrame=now;
    elapsed = now - startedAt;
    const timeLeft = Math.max(0, DURATION - elapsed);
    const spd = speedAt(elapsed);

    // milestones toasts
    if(timeLeft<=120000 && !loop._m2){ toast('‚ú® Two minutes to go'); loop._m2=true; }
    if(timeLeft<=60000  && !loop._m1){ toast('‚≠ê Final minute'); loop._m1=true; }
    if(timeLeft<=30000  && !loop._m30){ toast('üíû There she is...'); loop._m30=true; }

    // physics
    rocket.vy += GRAVITY;
    rocket.y  += rocket.vy;
    if(rocket.y<2){ rocket.y=2; rocket.vy=0; }
    if(rocket.y>H-rocket.h-2){ rocket.y=H-rocket.h-2; rocket.vy=0; }
    if(rocket.invuln>0) rocket.invuln -= dt;

    // FX & comets
    if(Math.random() < COMET_RATE*dt) spawnComet(now);
    maybeAddTrail(now, spd, dt);
    maybeDripSparkles(now);
    updateSparkles(dt, spd);
    updateButterflies(dt, spd);

    // cameo spawn triggers
    const minute = Math.floor((DURATION - timeLeft)/60000) + 1; // 1..3
    if(minute>=CAMEO_OWL_MINUTE && !owlCameo) owlCameo={x:W+30, y:30, t:0};
    if(minute>=CAMEO_BAT_MINUTE && !batCameo) batCameo={x:W+50, y:20, t:0};

    // spawning & preview logic
    if (elapsed < DURATION) {
      if (elapsed > START_GRACE && now > nextAsteroidAt) {
        obstacles.push(newAsteroid());
        const interval = asteroidIntervalAt(elapsed);
        nextAsteroidAt = now + interval * (0.7 + Math.random()*0.6);
        sfx('whoosh');
      }
      if (!gfPreview && timeLeft <= GF_PREVIEW_WINDOW) {
        gfPreview = { x: W - 40, y: H/2 - 10, w: GF_W, h: GF_H, sway: 0 };
      }
    } else {
      if (!girlfriend) spawnGirlfriend();
    }

    // keep preview ahead
    if (gfPreview && !girlfriend) {
      gfPreview.sway += 0.05;
      const minAhead = rocket.x + 110;
      const target = Math.min(W - 40, Math.max(minAhead, gfPreview.x - spd*dt*0.85));
      gfPreview.x = target;
      gfPreview.y = H/2 - 10 + Math.sin(gfPreview.sway)*1.0;
    }

    // move obstacles & score + NEAR-MISS
    const hitboxPad = ASSIST ? 2 : 0; // smaller effective hitbox in assist
    const rb = {x:rocket.x+hitboxPad,y:rocket.y+hitboxPad,w:rocket.w-2*hitboxPad,h:rocket.h-2*hitboxPad};

    for (let i=obstacles.length-1;i>=0;i--){
      const a=obstacles[i];
      a.x -= spd*dt; a.y += a.vy;
      if(a.x<-40) obstacles.splice(i,1);
      if(!a.scored && a.x + a.r < rocket.x){
        score++; a.scored = true;
        updateBestIfNeeded();                 /* NEW: live-update best */
      }

      // near-miss (no collision but very close)
      const close = !girlfriend && !a.nm &&
        !(rb.x >= a.x+a.r || rb.x+rb.w <= a.x-a.r || rb.y >= a.y+a.r || rb.y+rb.h <= a.y-a.r) ? false :
        (Math.abs((rb.x+rb.w/2) - a.x) <= (a.r + rb.w/2 + NEAR_MISS_PAD) &&
         Math.abs((rb.y+rb.h/2) - a.y) <= (a.r + rb.h/2 + NEAR_MISS_PAD));

      if(close){
        a.nm = true;
        score += NEAR_MISS_BONUS + Math.floor(combo*0.5);
        updateBestIfNeeded();                 /* NEW: also update if near-miss bumps best */
        combo++; comboDecayAt = now + COMBO_DECAY_MS;
        spawnNearMissAura(a.x, a.y);
        spawnButterflies(2);
        sfx('near'); vib(10);
      }
    }

    // combo decay
    if(combo>0 && now > comboDecayAt){ combo--; comboDecayAt = now + COMBO_DECAY_MS; }

    // draw frame
    drawFrame(dt, spd, timeLeft);

    // collisions (disabled only when real girlfriend exists)
    if(rocket.invuln<=0 && !girlfriend){
      for(const a of obstacles){
        if(aabb(rb.x,rb.y,rb.w,rb.h, a.x-a.r,a.y-a.r,a.r*2,a.r*2)){
          endCrash(); ui(); return;
        }
      }
    }

    // approach her and finish
    if(girlfriend){
      girlfriend.sway += 0.05; girlfriend.x -= spd*dt*0.85;
      if(girlfriend.x < rocket.x + 6){ drawEndingEmbrace(); ui(); endWin(); return; }
    }

    ui(timeLeft, spd);
    requestAnimationFrame(loop);
  }

  // near-miss aura (simple ring)
  let auras=[];
  function spawnNearMissAura(x,y){ if(REDUCED_FX) return; auras.push({x,y,r:2,a:1}); }
  function updateAuras(dt, spd){ for(let i=auras.length-1;i>=0;i--){ const A=auras[i]; A.r += 0.06*dt; A.a -= 0.003*dt; if(A.a<=0) auras.splice(i,1); } }
  function drawAuras(){ if(REDUCED_FX) return; for(const A of auras){ g.strokeStyle=`rgba(226,198,255,${0.6*A.a})`; g.lineWidth=1; g.beginPath(); g.arc(A.x|0, A.y|0, A.r|0, 0, Math.PI*2); g.stroke(); } }

  function drawFrame(dt, spd, timeLeft){
    clear();
    drawPlanets(dt, spd);
    drawNebula(dt, spd);
    drawStars(dt, spd);
    drawComets(dt, spd);

    drawTrail();
    drawAuras();
    updateAuras(dt, spd);

    if(pitbull) drawPitbull(dt, spd);
    drawOwl(dt, spd);
    drawBat(dt, spd);

    for(const a of obstacles){ drawAsteroid(a); }
    drawGirlfriendFallback(gfPreview);
    drawGirlfriendFallback(girlfriend);

    drawRocket();
    drawButterflies();
    drawSparkles();

    drawHUDOverlay(timeLeft);
    blit(); // copy low-res ‚Üí screen

    // HD draws (if images ready)
    drawChibiHD(gfPreview);
    drawChibiHD(girlfriend);
    drawAaronRiderHD();
  }

  function drawEndingEmbrace(){
    g.fillStyle='rgba(20,0,42,0.6)'; g.fillRect(0,0,W,H);
    for(let i=0;i<20;i++){ const x=(Math.random()*W)|0, y=(Math.random()*H)|0; g.fillStyle='#ff8ec6'; g.fillRect(x,y,1,1); g.fillRect(x+1,y,1,1); g.fillRect(x,y+1,1,1); }
    blit();
    drawChibiHD(girlfriend);
    drawAaronRiderHD();
  }

  function blit(){
    const vw=view.clientWidth, vh=view.clientHeight;
    const scale=Math.min(vw/W, vh/H);
    const dw=(W*scale)|0, dh=(H*scale)|0;
    const dx=((vw-dw)/2)|0, dy=((vh-dh)/2)|0;
    const dpr=window.devicePixelRatio||1;
    if(view.width!==vw*dpr || view.height!==vh*dpr){ view.width=vw*dpr; view.height=vh*dpr; ctx.imageSmoothingEnabled=false; }
    ctx.clearRect(0,0,view.width,view.height);
    ctx.save(); ctx.imageSmoothingEnabled=false; ctx.drawImage(buffer,0,0,W,H, dx*dpr,dy*dpr,dw*dpr,dh*dpr); ctx.restore();
    lastBlit = {dx, dy, scale, dpr};
  }

  function ui(timeLeft=Math.max(0,DURATION-(performance.now()-startedAt)), spd=speedAt(elapsed)){
    document.getElementById('score').textContent = score;
    document.getElementById('best').textContent = best;
    document.getElementById('combo').textContent = combo;
    document.getElementById('speed').textContent = ((spd/BASE_SPEED).toFixed(1)+'x');
    document.getElementById('timer').textContent = formatTime(timeLeft);
  }

  // screenshot
  function saveScreenshot(){
    try{
      const url = view.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = `love-run_${Date.now()}.png`; a.click();
    }catch(e){}
  }

  // init
  showIntro();
  const hideHint=()=>{ touchHint.style.display='none'; window.removeEventListener('touchstart',hideHint); window.removeEventListener('mousedown',hideHint); };
  window.addEventListener('touchstart',hideHint,{passive:true});
  window.addEventListener('mousedown',hideHint);
})();
</script>
</body>
</html>
